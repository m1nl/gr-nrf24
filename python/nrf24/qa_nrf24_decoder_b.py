#!/usr/bin/env python
# -*- coding: utf-8 -*-
#
# Copyright 2024 m1nl.
#
# SPDX-License-Identifier: GPL-3.0-or-later
#
import os

import pmt
from gnuradio import blocks, gr, gr_unittest
from gnuradio.nrf24 import nrf24_decoder_b


class nrf24_pdu_handler(gr.basic_block):
    def __init__(self):
        gr.basic_block.__init__(self, name="pdu_handler", in_sig=[], out_sig=[])
        self.pdu_port_name = "pdu"
        self.message_port_register_in(pmt.intern(self.pdu_port_name))
        self.set_msg_handler(pmt.intern(self.pdu_port_name), self.handle_pdu)

    def handle_pdu(self, pdu):
        metadata = pmt.car(pdu)
        data = pmt.cdr(pdu)

        if address := pmt.dict_ref(metadata, pmt.intern("address"), None):
            print(pmt.to_python(address))

        if payload := pmt.dict_ref(metadata, pmt.intern("payload"), None):
            print(pmt.to_python(payload))


class qa_nrf24_decoder_b(gr_unittest.TestCase):
    def setUp(self):
        self.tb = gr.top_block()

    def tearDown(self):
        self.tb = None

    def test_instance(self):
        instance = nrf24_decoder_b()

    def test_001_descriptive_test_name(self):
        src_data = list(
            map(
                int,
                "1010101011010011110101111101101100010010000001110001011100000000001000000000000000110111001010010111001001011111101111101011011011101011010111111000010010001001110010110111000100010000000100010001111100010001001110110000111111111111110111101111111111101010010101010110100111101011111011011000100100000011100010100000000000010000000000000001101110010100100110100101011110011111000011101110101001000010110100110110100100001100111000000101110100101111001011101110010000000000001001100110111000000010010001010111111111110111111111111110011111100101011101011010011110101111101101100010010000001110001010100000000001000000000000000110111001010010111000100001111001111100000011111001000111011110011001101011101100110000111111101110010000000000000001100110001000111110101101100000000100111111111111110010011100111101010101011010011110101111101101100010010000001110001011000000000001000000000000000110111001010010011011111111111101111100100011111011111111000111111111010011100001001011100010111011111110111000100000000000000000001000000000000000000000000000000000000100010101101100000000010010101010110100111101011111011011000100100000011100010111000000000010000000000000001101110010100101110010010111111011110111111110101001111101001111111110000110110010100101001110111111101110001000000000000000000000000000000000000000000000000100010000000001000000000000000100101010101101001111010111110110110001001000000111000101000000000000100000000000000011011100101001001101001010111100111111001110110100100011110000101000010001100010010011010110100110111111110111000100000000000000010000000000000000000000000000000000000000100011001000000000000010010101010110100111101011111011011000100100000011100010101000000000010000000000000001101110010100101110001000011110011",
            )
        )

        src = blocks.vector_source_b(src_data)
        decoder = nrf24_decoder_b()
        pdu_handler = nrf24_pdu_handler()

        self.tb.connect(src, decoder)
        self.tb.msg_connect(decoder, pmt.intern("pdu"), pdu_handler, pmt.intern("pdu"))

        self.tb.run()


if __name__ == "__main__":
    gr_unittest.run(qa_nrf24_decoder_b)
